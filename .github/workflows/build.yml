name: Build & Package Transcribrr

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

env:
  PYTHON_VERSION: '3.9'

jobs:
  win:
    runs-on: windows-latest
    strategy:
      matrix:
        flavour: [cpu, cuda]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build deps
        shell: bash
        run: |
          python -m pip install --upgrade pip wheel
          if [[ "${{ matrix.flavour }}" == "cuda" ]]; then
            python -m pip install torch torchvision torchaudio \
              --index-url https://download.pytorch.org/whl/cu118
          else
            python -m pip install torch torchvision torchaudio
          fi
          python -m pip install "pyinstaller==6.*" pyqt6 -r requirements.txt
          choco install ffmpeg -y

      - name: Prepare FFmpeg binaries
        shell: pwsh
        run: |
          # Create bin directory in project root for the spec file to find
          New-Item -ItemType Directory -Force "bin"
          # Find FFmpeg executables installed by Chocolatey
          $ffmpegPath = (Get-Command ffmpeg.exe).Source
          $ffprobePath = (Get-Command ffprobe.exe).Source
          # Copy to the bin directory
          Copy-Item $ffmpegPath "bin/ffmpeg.exe"
          Copy-Item $ffprobePath "bin/ffprobe.exe"

      - name: Freeze with PyInstaller
        shell: bash
        run: |
          pyinstaller transcribrr.spec --noconfirm --clean
          mv dist/Transcribrr "dist/Transcribrr_${{ matrix.flavour }}"

      - name: Build installer with Inno Setup
        shell: pwsh
        run: |
          $inno = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $inno)) { choco install innosetup -y }
          & $inno /DFlavour=${{ matrix.flavour }} installer\transcribrr_setup.iss

      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: Transcribrr_windows_${{ matrix.flavour }}
          path: |
            dist/Transcribrr-windows-${{ matrix.flavour }}-setup.exe
            dist/Transcribrr_${{ matrix.flavour }}
